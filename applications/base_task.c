/**
 * File    	:  base_task.c
 * author	:  mayunliang
 * This file is part of WGB-900
 * Copyright (C), 2012, XJ ELECTRIC Co., LTD.
 * Date     :  2012-10-03
 * Function	:  创建日常事务，初始化系统、存取mram、执行各项自检
			   读取测量数据、清看门狗、运行灯、对时等

 * Change Logs :
 * Date             Author           Notes
 * 2012-10-03     mayunliang      the first version
*/

//#include "i2c_rtc.h"
#include "protect.h"
#include "confresolve.h"
#include "crc.h"
#include "base_task.h"



// CRC 高位字节值表
extern const uint8_t auchCRCHi[];
// CRC低位字节值表
extern const uint8_t auchCRCLo[];

rt_uint8_t zzaddr, zzaddr_0, zzaddr_1, zzaddr_3, zzaddr_4, zzaddr_5, zzaddr_6, zzaddr_7;

rt_uint32_t baudrate_0, baudrate_1, baudrate_3, baudrate_4, baudrate_5, baudrate_6, baudrate_7;
rt_uint16_t parity_0, parity_1, parity_3, parity_4, parity_5, parity_6, parity_7;
rt_uint16_t protocol_0, protocol_1, protocol_3, protocol_4, protocol_5, protocol_6, protocol_7;
rt_uint8_t  uart_monitor_buf[255];//监视报文
uint32_t eth_IP1, eth_MASK1, eth_GW1, eth_IP2, eth_MASK2, eth_GW2;
uint8_t CheckADETime;
uint16_t DEVICE_CRC;
unsigned char sysconfflg[1];


struct  UART_CONF uartpara[UARTMAXNUM];
struct  UART_TXRX_STATUS uart_status[UARTMAXNUM];
struct ETH_TXRX_STATUS eth_status;
struct ETH_CONF ethpara;
struct FILE_INFDEFINE fileinf;

struct  UART_CONF uartpara[UARTMAXNUM] = {
{	  0,//该串口在用
	  0,//通道序号
	  1,//通道号
	  0,//通道类型
	2,	//规约类型 
	500,//查询间隔时间 
	500,//接收等待时间    
	0,//网关模式
	0,//串口号    	  
	0,//波特率
	8,//数据宽度
	1,//停止位 
	0,//效验方式
	0,//串口类型    
	20,    //设备数量
	{0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0a,0x0b,0x0c,0x0d,0x0e,0x0f,0x10,0x11,0x12,0x13,0x14}//设备地址
	/*{{0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 0
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 5
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 10
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 15
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01}//device 20

		}*/
		/*{0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0a,0x0b,0x0c,0x0d,0x0e,0x0f,0x10,0x11,0x12,0x13,0x14},
		{{0x01,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},//device 0
		 {0x02,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x03,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x04,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x05,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},//device 5
		 {0x06,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x07,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x08,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x09,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x0a,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},//device 10
		 {0x0b,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x0c,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x0d,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x0e,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x0f,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},//device 15
		 {0x10,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x11,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x12,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x13,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01},
		 {0x14,0x04,0x2000,0x12,   0x02,0x0000,0x30,  0x05,0x3000,0x01,  0x06,0x4000,0x01,  0x04,0x2100,0x08,  0x03,0x1000,0x01,  0x10,0x1000,0x01}//device 20	*/
		},//串口0定义

	{	  0,//该串口在用
		  1,//通道序号
		  2,//通道号
		  0,//通道类型
		0,	//规约类型 
		500,//查询间隔时间 
		500,//接收等待时间    
		0,//网关模式
		1,//串口号    	  
		0,//波特率
		8,//数据宽度
		1,//停止位 
		0,//效验方式
		0,//串口类型    
		20,    //设备数量
		{0xc1,0xc2,0xc3,0xc4,0xc5,0xc6,0xc7,0xc8,0xc9,0xca,0xcb,0xcc,0xcd,0xce,0xcf,0xd0,0xd1,0xd2,0xd3,0xd4}
	/*{{0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 0
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 5
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 10
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 15
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01}//device 20

		}*/

	},//串口1定义

{	  0,//该串口在用
	  2,//通道序号
	  3,//通道号
	  0,//通道类型
	0,	//规约类型 
	500,//查询间隔时间 
	500,//接收等待时间    
	0,//网关模式
	2,//串口号    	  
	0,//波特率
	8,//数据宽度
	1,//停止位 
	0,//效验方式
	0,//串口类型    
	20,    //设备数量
	{0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0a,0x0b,0x0c,0x0d,0x0e,0x0f,0x10,0x11,0x12,0x13,0x14}
	/*{{0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 0
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 5
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 10
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 15
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01}//device 20

		}*/

	},//串口2定义

{	  0,//该串口在用
	  3,//通道序号
	  4,//通道号
	  0,//通道类型
	0,	//规约类型 
	500,//查询间隔时间 
	500,//接收等待时间    
	0,//网关模式
	3,//串口号    	  
	0,//波特率
	8,//数据宽度
	1,//停止位 
	0,//效验方式
	0,//串口类型    
	20,    //设备数量
	{0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2a,0x2b,0x2c,0x2d,0x2e,0x2f,0x30,0x31,0x32,0x33,0x34}
	/*{{0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 0
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 5
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 10
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 15
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01}//device 20

		}*/

	},//串口3定义	

{	  0,//该串口在用
	  4,//通道序号
	  5,//通道号
	  0,//通道类型
	0,	//规约类型 
	500,//查询间隔时间 
	500,//接收等待时间    
	0,//网关模式
	4,//串口号    	  
	0,//波特率
	8,//数据宽度
	1,//停止位 
	0,//效验方式
	0,//串口类型    
	20,    //设备数量
	{0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4a,0x4b,0x4c,0x4d,0x4e,0x4f,0x50,0x51,0x52,0x53,0x54}
	/*{{0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 0
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 5
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 10
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 15
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01}//device 20

		}*/

	},//串口4定义	


{	  0,//该串口在用
	  5,//通道序号
	  6,//通道号
	  0,//通道类型
	0,	//规约类型 
	500,//查询间隔时间 
	500,//接收等待时间    
	0,//网关模式
	5,//串口号    	  
	0,//波特率
	8,//数据宽度
	1,//停止位 
	0,//效验方式
	0,//串口类型    
	20,    //设备数量
	{0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6a,0x6b,0x6c,0x6d,0x6e,0x6f,0x70,0x71,0x72,0x73,0x74}
	/*{{0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 0
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 5
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 10
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 15
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01}//device 20

		}*/

	},//串口5定义		



{	  0,//该串口在用
	  6,//通道序号
	  7,//通道号
	  0,//通道类型
	0,	//规约类型 
	500,//查询间隔时间 
	500,//接收等待时间    
	0,//网关模式
	6,//串口号    	  
	0,//波特率
	8,//数据宽度
	1,//停止位 
	0,//效验方式
	0,//串口类型    
	20,    //设备数量
	{0x81,0x82,0x83,0x84,0x85,0x86,0x87,0x88,0x89,0x8a,0x8b,0x8c,0x8d,0x8e,0x8f,0x90,0x91,0x92,0x93,0x94}
	/*{{0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 0
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 5
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 10
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 15
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01}//device 20

		}*/

	},//串口6定义	

{	  0,//该串口在用
	  7,//通道序号
	  8,//通道号
	  0,//通道类型
	0,	//规约类型 
	500,//查询间隔时间 
	500,//接收等待时间    
	0,//网关模式
	7,//串口号    	  
	0,//波特率
	8,//数据宽度
	1,//停止位 
	0,//效验方式
	0,//串口类型    
	20,    //设备数量
	{0xa1,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,0xa8,0xa9,0xaa,0xab,0xac,0xad,0xae,0xaf,0xb0,0xb1,0xb2,0xb3,0xb4}
	/*{{0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 0
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 5
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 10
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},//device 15
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01},
	 {0x12,   0x30,  0x01,  0x01,  0x08,  0x01,  0x01}//device 20

		}*/

	}//串口7定义	


};

/**
 * This routine is used to calculate the CRC check sum.
 *
 */

void crc_calculate(void)
{
	rt_kprintf("CRC Calculate\n");
	DEVICE_CRC = crc32((uint8_t*)0x00, 0x100000);
}


/**
 * This routine is used to kick dog.
 *
 */
void KickDog_Handler(void)
{

}

/**
 * This routine is used to .
 *
 */
extern void get_rtc(void);
extern void delay(uint16_t temp);
extern void filetoconf(uint8_t* confbuf);
extern void I2C_Read_nbyte(unsigned char* buf1, unsigned int MemAddr, unsigned char length);
extern void I2C_Write_nByte(unsigned int MemAddr, unsigned char* buf, unsigned char length);


void run_init(void)
{
	uint8_t i;
	uint8_t tempdata[2];


	//读取配置信息版本I2C_Write_nByte(ADDR_DEFINE,(uint8_t*)&sysconfflg,2);
	I2C_Read_nbyte((uint8_t*)& sysconfflg, ADDR_DEFINE, 1);
	delay(10);
	//读取配置串口1配置信息
	I2C_Read_nbyte((uint8_t*)& uartpara[0], UART_CONF_AREA_0, sizeof(uartpara[0]));
	delay(10);
	//rt_thread_delay(1);
	//读取配置串口1配置信息
	I2C_Read_nbyte((uint8_t*)& uartpara[1], UART_CONF_AREA_1, sizeof(uartpara[1]));
	delay(10);
	//rt_thread_delay(1);
	//读取配置串口2配置信息
	//I2C_Read_nbyte((uint8_t*)&uartpara[2],UART_CONF_AREA_2,sizeof(uartpara[2]));
	//rt_thread_delay(1);
	//读取配置串口3配置信息
	I2C_Read_nbyte((uint8_t*)& uartpara[3], UART_CONF_AREA_3, sizeof(uartpara[3]));
	delay(10);
	//rt_thread_delay(1);
	//读取配置串口4配置信息
	I2C_Read_nbyte((uint8_t*)& uartpara[4], UART_CONF_AREA_4, sizeof(uartpara[4]));
	delay(10);
	//rt_thread_delay(1);
	//读取配置串口5配置信息
	I2C_Read_nbyte((uint8_t*)& uartpara[5], UART_CONF_AREA_5, sizeof(uartpara[5]));
	delay(10);
	//rt_thread_delay(1);
	//读取配置串口6配置信息
	I2C_Read_nbyte((uint8_t*)& uartpara[6], UART_CONF_AREA_6, sizeof(uartpara[6]));
	delay(10);
	//rt_thread_delay(1);
	//读取配置串口7配置信息
	I2C_Read_nbyte((uint8_t*)& uartpara[7], UART_CONF_AREA_7, sizeof(uartpara[7]));
	delay(10);
	//rt_thread_delay(1);


	//读取网口配置信息
	if (sysconfflg[0] != 0x55)//装置未配置过
	{
		ethpara.eth_IP1 = 0x0b646402;
	}
	else
	{
		I2C_Read_nbyte((uint8_t*)& ethpara, ETH_CONF_AREA, sizeof(ethpara));
	}

	/**get timer**/
	get_rtc();
	tempdata[0] = 1;
	I2C_Write_nByte(CAL_CONF_AREA, (uint8_t*)tempdata, 2);
	I2C_Read_nbyte((uint8_t*)tempdata, CAL_CONF_AREA, 2);
	if (tempdata[0] != 1)
	{
		rt_kprintf("系统重启\n");

		NVIC_SystemReset();//实现系统复位
	}


}


/*
********************************************************************************************
***************************************线程0入口********************************************
* This function will initial some hardwares on board, such as eeprom, input and output pins.
* this function will check the board,and will just run once time in the system first run.
 *******************************************************************************************
 */
static void prepare_work_thread_entry(void* parameter)
{




}

void measure_calculate(void);

#define rt_hw_led_on()     bFM3_GPIO_PDORF_P6 = 1
#define rt_hw_led_off()    bFM3_GPIO_PDORF_P6 = 0
#define rt_hw_led_flash()  bFM3_GPIO_PDORF_P6 ^= 1


void analog_calculate(void);

/*
******************************************************************
*****************************线程1入口****************************
******************************************************************
*/
extern void init_sram(void);
extern void Kick_WatchDog(void);

static void normal_work_thread_entry(void* parameter)
{
	uint8_t  i = 0;
	init_sram();
	while (1)
	{
		/* run-led flash */
		rt_hw_led_flash();
		//KickDog_Handler();
		if (i > 2)
		{
			Kick_WatchDog();
			i = 0;
		}
		else
			i++;
		// rt_kprintf("Kick dog\n");
		set_rtc();
		rt_thread_delay(RT_TICK_PER_SECOND / 2); /* sleep 0.5 second*/
	}
}

/*
******************************************************************
*****************************线程3入口****************************
******************************************************************
*/

void rtdbproce(void);

static void rtdb_work_thread_entry(void* parameter)
{
	while (1)
	{
		//rtdbproce();
		rt_thread_delay(RT_TICK_PER_SECOND * 10);
	}
}
//extern uint8_t AT_600A_flag; /******autotest**********/
/* 邮箱控制块 */
struct rt_mailbox mb;
/* 用于放邮件的内存池 */
ALIGN(4)
static char mb_pool[200];

/*
******************************************************************
*****************************线程4入口****************************
******************************************************************
*/

extern void set_if_h(char* netif_name, uint32_t ip_addr, uint32_t gw_addr, uint32_t nm_addr);
extern void I2C_Write_nByte(unsigned int MemAddr, unsigned char* buf, unsigned char length);//addr buf length
static void save_data_thread_entry(void* parameter)
{
	rt_uint32_t mbdata;//高字节数据类型，低字节数据
	uint8_t* ptr;
	uint8_t  i;
	while (1)
	{
		/* 从邮箱中收取邮件 */
		if (rt_mb_recv(&mb, (rt_uint32_t*)& mbdata, RT_WAITING_FOREVER) == RT_EOK)
		{
			rt_kprintf("eeprom: get a mail:%08x\n", mbdata);
			switch (mbdata & 0xff000000)
			{
			case TYPE_RECORD_ETH:
				I2C_Write_nByte(UART_CONF_AREA_0, (uint8_t*)& uartpara[0], sizeof(uartpara[0]));
				I2C_Write_nByte(UART_CONF_AREA_1, (uint8_t*)& uartpara[1], sizeof(uartpara[1]));
				I2C_Write_nByte(UART_CONF_AREA_3, (uint8_t*)& uartpara[3], sizeof(uartpara[3]));
				I2C_Write_nByte(UART_CONF_AREA_4, (uint8_t*)& uartpara[4], sizeof(uartpara[4]));
				I2C_Write_nByte(UART_CONF_AREA_5, (uint8_t*)& uartpara[5], sizeof(uartpara[5]));
				I2C_Write_nByte(UART_CONF_AREA_6, (uint8_t*)& uartpara[6], sizeof(uartpara[6]));
				I2C_Write_nByte(UART_CONF_AREA_7, (uint8_t*)& uartpara[7], sizeof(uartpara[7]));
				I2C_Write_nByte(ETH_CONF_AREA, (uint8_t*)& ethpara, sizeof(ethpara));
				sysconfflg[0] = 0x55;
				I2C_Write_nByte(ADDR_DEFINE, (uint8_t*)& sysconfflg, 1);
				break;
				/*case TYPE_RECORD_DEFINE:
					break;
				case TYPE_RECORD_UART0:
					//ptr = uartpara;
				  I2C_Write_nByte(UART_CONF_AREA_0,(uint8_t*)&uartpara[0],sizeof(uartpara[0]));

					break;
				case TYPE_RECORD_UART1:
					I2C_Write_nByte(UART_CONF_AREA_1,(uint8_t*)&uartpara[1],sizeof(uartpara[1]));
					break;
				case TYPE_RECORD_UART2:

					break;
				case TYPE_RECORD_UART3:

					break;
				case TYPE_RECORD_UART4:

					break;
				case TYPE_RECORD_UART5:

					break;
				case TYPE_RECORD_UART6:

					break;
				case TYPE_RECORD_UART7:

					break;
				case TYPE_RECORD_ETH:

					break;		*/

			default:
				break;
			}
		}
		while (dma_status)  //如果忙，延时1个tick
		{
			/* 延时1个OS Tick */
			rt_thread_delay(1);
		}
		if ((mbdata & 0xff000000) == TYPE_RECORD_ETH)//修改完以太网配置，配置结束，重启系统
		{
			NVIC_SystemReset();//实现系统复位 

		}
	}

}

void normal_routine(void)
{
	rt_thread_t tid;

	/* 初始化一个mailbox */
	rt_mb_init(&mb,
			   "mbt",             /* 名称是mbt */
			   &mb_pool[0],       /* 邮箱用到的内存池是mb_pool */
			   sizeof(mb_pool) / 4, /* 最大邮件数 */
			   RT_IPC_FLAG_FIFO); /* 采用FIFO方式进行线程等待 */

	rt_kprintf(" normal routine create\n");

	/* 创建线程0 *///负责处理数据库 上送 和下发数据
	tid = rt_thread_create("t0", rtdb_work_thread_entry, RT_NULL,
		1024, 5, 5);
	if (tid != RT_NULL) rt_thread_startup(tid);

	/* 创建线程1 */
	tid = rt_thread_create("t1", normal_work_thread_entry, (void*)0,//RT_NULL,
		1024, 22, 5);
	if (tid != RT_NULL) rt_thread_startup(tid);


	/* 创建线程4 */
	tid = rt_thread_create("t4", save_data_thread_entry, RT_NULL,
		512 * 2, 23, 5);
	if (tid != RT_NULL)	rt_thread_startup(tid);


}
/*@}*/

